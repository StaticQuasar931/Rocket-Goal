<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/ftbaldana/poklp@main/aaaaaa/TemplateData/style.css">
    <link rel="manifest" href="https://cdn.jsdelivr.net/gh/ftbaldana/poklp@main/aaaaaa/manifest.webmanifest">

    <script src="https://playgama.com/ads/pockethaven.v0.1.js"></script>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/10.2.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.2.0/firebase-analytics-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.2.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.2.0/firebase-remote-config-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.2.0/firebase-firestore-compat.js"></script>
    <script>
      if (window.location.href.includes("dev")) {
        const s = document.createElement("script");
        s.src = "firebase/firebase_dev.js";
        document.head.appendChild(s);
      }
    </script>

    <script src="https://cdn.jsdelivr.net/gh/ftbaldana/poklp@main/aaaaaa/firebase/firebase.js"></script>

    <!-- Xsolla Scripts -->
    <script src="https://cdn.jsdelivr.net/gh/ftbaldana/poklp@main/aaaaaa/xsolla/xsolla.js"></script>

    <script src="https://cdn.jsdelivr.net/gh/ftbaldana/poklp@main/aaaaaa/utils.js"></script>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-ZN6YDCFCY8"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-ZN6YDCFCY8');
    </script>

    <style>
      body { background: #000; }
      #unity-canvas { outline: none; }
    </style>
  </head>

  <body>
    <div id="unity-container">
      <canvas id="unity-canvas" width="960" height="600" tabindex="-1" data-sl="canvas-lq"></canvas>
      <div id="unity-loading-bar">
        <div id="loading-logo"></div>
        <div id="unity-progress-bar-empty">
          <div id="unity-progress-bar-full"></div>
        </div>
      </div>
      <div id="unity-warning"> </div>
    </div>

    <script>
      var container = document.querySelector("#unity-container");
      var canvas = document.querySelector("#unity-canvas");
      var loadingBar = document.querySelector("#unity-loading-bar");
      var progressBarFull = document.querySelector("#unity-progress-bar-full");
      var warningBanner = document.querySelector("#unity-warning");

      function unityShowBanner(msg, type) {
        function updateBannerVisibility() {
          warningBanner.style.display = warningBanner.children.length ? 'block' : 'none';
        }
        var div = document.createElement('div');
        div.innerHTML = msg;
        warningBanner.appendChild(div);
        if (type == 'error') div.style = 'background: red; padding: 10px;';
        else {
          if (type == 'warning') div.style = 'background: yellow; padding: 10px;';
          setTimeout(function() {
            warningBanner.removeChild(div);
            updateBannerVisibility();
          }, 5000);
        }
        updateBannerVisibility();
      }

      // ===== Latest-commit pointer via GitHub Pages (plain text) =====
      // Put the current commit SHA (one line) here:
      // https://danidrorm.github.io/RGFiles/latest.txt
      var LATEST_TXT_URL = "https://danidrorm.github.io/RGFiles/latest.txt";

      // Base repo for jsDelivr
      var REPO_CDN_BASE = "https://cdn.jsdelivr.net/gh/Danidrorm/RGFiles@";

      // Your Unity build file names (relative to buildUrl)
      // If these hashes change per Unity build, just update them here once per build.
      // If you overwrite files with the SAME names, this still works because buildUrl is pinned to a commit.
      var UNITY_FILES = {
        loader: "b23dd96997961653e2825455633aac82.loader.js",
        data: "1c6b3fb6706375cf5f4e35c5d914385e.data.unityweb",
        framework: "98438f2e7a94945eb0c97aa68a131683.framework.js.unityweb",
        wasm: "def2138bbbbbb3dc09c6c604c4109263.wasm.unityweb",
      };

      function isValidGitSha(ref) {
        // allow short or full SHA (7..40 hex)
        return /^[a-f0-9]{7,40}$/i.test(ref);
      }

      async function fetchLatestRef() {
        // cache-bust + no-store to fight browser/proxy caches for the tiny pointer file
        var url = LATEST_TXT_URL + "?t=" + Date.now();

        var res = await fetch(url, { cache: "no-store" });
        if (!res.ok) throw new Error("Failed to fetch latest.txt: " + res.status);

        var ref = (await res.text()).trim();
        if (!isValidGitSha(ref)) throw new Error("latest.txt returned invalid SHA: " + ref);

        return ref;
      }

      function loadScript(src) {
        return new Promise((resolve, reject) => {
          var script = document.createElement("script");
          script.src = src;
          script.onload = resolve;
          script.onerror = () => reject(new Error("Failed to load script: " + src));
          document.body.appendChild(script);
        });
      }

      loadingBar.style.display = "block";

      (async function bootUnity() {
        var ref;
        try {
          ref = await fetchLatestRef();
        } catch (e) {
          console.warn("latest.txt fetch failed, falling back to @main (may be stale):", e);
          ref = "main"; // fallback branch
        }

        var buildUrl = REPO_CDN_BASE + ref;

        var loaderUrl = buildUrl + "/" + UNITY_FILES.loader;

        var config = {
          dataUrl: buildUrl + "/" + UNITY_FILES.data,
          frameworkUrl: buildUrl + "/" + UNITY_FILES.framework,
          codeUrl: buildUrl + "/" + UNITY_FILES.wasm,
          streamingAssetsUrl: "StreamingAssets",
          productVersion: "0.302",
          showBanner: unityShowBanner,
        };

        try {
          await loadScript(loaderUrl);
        } catch (e) {
          alert(e.message || String(e));
          return;
        }

        createUnityInstance(canvas, config, (progress) => {
          progressBarFull.style.width = (100 * progress) + "%";
        }).then((unityInstance) => {
          loadingBar.style.display = "none";

          window.unityInstance = unityInstance;
          window.unityGame = unityInstance;

          initializeFirebase(unityInstance);
          initializeUtils(unityInstance);

        }).catch((message) => {
          alert(message);
        });
      })();
    </script>

    <!-- Sticky Bottom Center Ad (728x90) with Smooth Slide-Out and Reappearance -->
    <style>
      #ad-container {
        position: fixed;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: min(728px, calc(100% - 20px));
        height: 90px;
        background: rgba(0, 0, 0, 0.90);
        display: none;
        z-index: 99999;
        border-radius: 0;
        overflow: hidden;
        box-shadow: 0 -2px 12px rgba(0, 0, 0, 0.45);
        box-sizing: border-box;
        transition: transform 0.5s ease-in-out;
      }

      #ad-container.hidden {
        transform: translate(-50%, 100%);
      }

      #ad-iframe {
        position: absolute;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 745px;
        height: 90px;
        border: 0;
        display: block;
        overflow: hidden;
        pointer-events: auto;
        box-sizing: content-box;
        -ms-overflow-style: none;
        scrollbar-width: none;
      }

      #ad-iframe::-webkit-scrollbar {
        display: none;
        width: 0;
        height: 0;
      }

      #close-ad {
        position: absolute;
        top: 6px;
        right: 8px;
        background: #ff4d4d;
        color: #fff;
        border: none;
        padding: 5px 9px;
        font-size: 13px;
        border-radius: 4px;
        cursor: not-allowed;
        opacity: 0.72;
        z-index: 100000;
        display: flex;
        align-items: center;
      }
      #close-ad.enabled {
        cursor: pointer;
        opacity: 1;
      }
      #close-ad::before {
        content: '↓';
        margin-right: 4px;
      }

      #ad-right-mask {
        position: absolute;
        top: 0;
        right: 0;
        width: 12px;
        height: 100%;
        pointer-events: none;
        background: linear-gradient(to right, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.9));
        z-index: 99999;
      }

      @media (max-width: 440px) {
        #ad-container {
          width: calc(100% - 12px);
          left: 50%;
          transform: translateX(-50%);
          border-radius: 0;
        }
        #ad-iframe { width: 728px; }
      }
    </style>

    <div id="ad-container" aria-hidden="true" role="dialog" aria-label="Advertisement">
      <iframe
        id="ad-iframe"
        src="https://script.google.com/macros/s/AKfycbzNG4z_PlG6Ke_bX5wSPKK2uBRB3IY9ouVzqM1shucYhSTvsJWRmyMyZaaC2z5S3ADN/exec"
        width="768px"
        height="95px"
        scrolling="no"
        frameborder="0"
        sandbox="allow-scripts allow-popups allow-same-origin"
      ></iframe>
      <button id="close-ad" disabled>Close (12)</button>
      <div id="ad-right-mask"></div>
    </div>

    <script>
      (function () {
        const showDelay = 10000;
        const countdownStart = 12;
        const reappearDelay = 120000;
        const adContainer = document.getElementById('ad-container');
        const closeBtn = document.getElementById('close-ad');

        function showAd() {
          adContainer.style.display = 'block';
          adContainer.classList.remove('hidden');
          adContainer.setAttribute('aria-hidden', 'false');

          let timeLeft = countdownStart;
          closeBtn.textContent = `Close (${timeLeft})`;
          closeBtn.disabled = true;
          closeBtn.classList.remove('enabled');

          const t = setInterval(() => {
            timeLeft--;
            if (timeLeft > 0) {
              closeBtn.textContent = `Close (${timeLeft})`;
            } else {
              clearInterval(t);
              closeBtn.disabled = false;
              closeBtn.classList.add('enabled');
              closeBtn.textContent = 'Close ↓';
            }
          }, 1000);
        }

        setTimeout(showAd, showDelay);

        closeBtn.addEventListener('click', () => {
          if (closeBtn.disabled) return;
          adContainer.classList.add('hidden');
          adContainer.setAttribute('aria-hidden', 'true');
          setTimeout(showAd, reappearDelay);
        });
      })();
    </script>

  </body>
</html>
